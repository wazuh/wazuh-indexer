name: Build packages

# This workflow runs when any of the following occur:
# - Run manually
on:
  push:
    # Sequence of patterns matched against refs/heads
    branches:
      - "ci/*"
  workflow_dispatch:
    inputs:
      revision:
        description: "Revision"
        type: string
        default: "0"
      upload:
        description: "Upload ?"
        type: bool
        default: false
      is_release:
        description: "Upload ?"
        type: bool
        default: false
      distribution:
        description: "[ 'tar', 'rpm', 'deb', 'docker' ]"
        type: string
        default: "[ 'rpm', 'deb' ]"
      architecture:
        description: "[ 'x64', 'arm64' ]"
        type: string
        default: "[ 'x64' ]"

# ==========================
# Bibliography
# ==========================
#
# * Reusable workflows: limitations
#   | https://docs.github.com/en/actions/using-workflows/reusing-workflows#limitations
# * Using matrix in reusable workflows:
#   | https://docs.github.com/en/actions/using-workflows/reusing-workflows#using-a-matrix-strategy-with-a-reusable-workflow
# * Reading input from the called workflow
#   | https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callinputs
# * Ternary operator
#   | https://docs.github.com/en/actions/learn-github-actions/expressions#example

jobs:
  build:
    strategy:
      matrix:
        distribution: ${{ inputs.distribution }}
        architecture: ${{ inputs.architecture }}
        exclude:
          # skip arm64 until we have arm runners
          - architecture: arm64
        fail-fast: false
    uses: ./.github/workflows/r_build.yml
    with:
      revision: ${{ github.event_name == 'push' && '0' || inputs.revision }}
      upload: ${{ inputs.upload }}
      is_release: ${{ inputs.is_release }}
      distribution: ${{ matrix.distribution }}
      architecture: ${{ matrix.architecture }}
