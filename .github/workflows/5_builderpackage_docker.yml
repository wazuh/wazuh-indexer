run-name: Build Wazuh Indexer Docker image | ${{ inputs.id }}
name: (5.x) Build Docker image

# This workflow runs when any of the following occur:
# - Run manually
# - Invoked from another workflow

on:
  workflow_dispatch:
    inputs:
      revision:
        description: "Revision number of the package."
        type: string
        default: "0"
        required: false
      is_stage:
        description: "Enable to use the release naming nomenclature."
        type: boolean
        default: false
      architecture:
        description: '[ "x64", "arm64" ]'
        type: string
        default: '[ "x64", "arm64" ]'
      id:
        description: "ID used to identify the workflow uniquely."
        type: string
        required: false
      plugins_ref:
        description: "Branch, commit or tag for the wazuh-indexer plugins repositories and engine."
        type: string
        default: "main"
        required: false
  workflow_call:
    inputs:
      revision:
        description: "Revision number of the package."
        type: string
        default: "0"
        required: false
      is_stage:
        description: "Enable to use the release naming nomenclature."
        type: boolean
        default: false
      architecture:
        description: '[ "x64", "arm64" ]'
        type: string
        default: '[ "x64", "arm64" ]'
      id:
        description: "ID used to identify the workflow uniquely."
        type: string
        required: false
      plugins_ref:
        description: "Branch, commit or tag for the wazuh-indexer plugins repositories and engine."
        type: string
        default: "main"
        required: false
    secrets:
      QUAY_USERNAME:
        required: true
        description: "Quay.io username"
      QUAY_TOKEN:
        required: true
        description: "Quay.io token"

# ==========================
# Bibliography
# ==========================
#
# * Reusable workflows: limitations
#   | https://docs.github.com/en/actions/using-workflows/reusing-workflows#limitations
# * Using matrix in reusable workflows:
#   | https://docs.github.com/en/actions/using-workflows/reusing-workflows#using-a-matrix-strategy-with-a-reusable-workflow
# * Reading input from the called workflow
#   | https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callinputs
# * Ternary operator
#   | https://docs.github.com/en/actions/learn-github-actions/expressions#example

jobs:
  call-build-workflow:
    permissions:
      contents: read
      id-token: write
      actions: read
      packages: read
    uses: ./.github/workflows/5_builderpackage_indexer.yml
    with:
      revision: ${{ inputs.revision }}
      is_stage: ${{ inputs.is_stage }}
      distribution: '[ "tar" ]'
      architecture: '[ "x64" ]'
      id: ${{ inputs.id }}
      plugins_ref: ${{ inputs.plugins_ref }}
    secrets: inherit

  build-and-push-docker-image:
    permissions:
      contents: read
    needs: [call-build-workflow]
    runs-on: ubuntu-24.04
    env:
      docker_path: ./build-scripts/docker
    steps:
      - uses: actions/checkout@v5

      - name: Get version
        id: version
        run: |
          echo "version=$(bash build-scripts/product_version.sh)" >> "$GITHUB_OUTPUT"

      - name: Resolve platforms
        id: platforms
        run: |
          platforms=$(echo '${{ inputs.architecture }}' | jq -r '[.[] | if . == "x64" then "linux/amd64" elif . == "arm64" then "linux/arm64" else empty end] | join(",")')
          echo "platforms=${platforms}" >> "$GITHUB_OUTPUT"

      - name: Download tarball
        uses: actions/download-artifact@v5
        with:
          path: ${{ env.docker_path }}
          pattern: "wazuh-indexer_*linux*"
          merge-multiple: true

      - name: Display structure of downloaded files
        run: ls -lR ${{ env.docker_path }}

      - name: Resolve tarball name
        id: tarball
        run: |
          name=$(ls ${{ env.docker_path }}/wazuh-indexer_*.tar.gz | head -1 | xargs basename)
          echo "name=${name}" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Quay.io
        env:
          QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
          QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}
        run: |
          docker login -u="${QUAY_USERNAME}" -p="${QUAY_TOKEN}" quay.io

      - name: Build and push multi-arch image
        env:
          DOCKER_REPOSITORY: quay.io/wazuh/wazuh-indexer
          VERSION: ${{ steps.version.outputs.version }}
          REVISION: ${{ inputs.revision || '0' }}
        run: |
          cd ${{ env.docker_path }}
          docker buildx build \
            --platform ${{ steps.platforms.outputs.platforms }} \
            --build-arg="VERSION=${VERSION}" \
            --build-arg="INDEXER_TAR_NAME=${{ steps.tarball.outputs.name }}" \
            --tag="${DOCKER_REPOSITORY}:${VERSION}-${REVISION}" \
            --push \
            --progress=plain --no-cache .
