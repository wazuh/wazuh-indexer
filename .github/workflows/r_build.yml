name: Build pipeline (reusable)

# This workflow runs when any of the following occur:
# - Run from another workflow
on:
  workflow_call:
    inputs:
      revision:
        description: "Revision number"
        type: string
        default: "0"
      upload:
        description: "Uploads artifacts"
        type: boolean
        default: false
      is_release:
        description: "Uses release's nomenclature"
        type: boolean
        default: false
      distribution:
        description: One of "[ 'tar', 'rpm', 'deb', 'docker' ]"
        type: string
        required: true
      architecture:
        description: One of "[ 'x64', 'arm64' ]"
        type: string
        required: true

jobs:
  build_min:
    uses: ./.github/workflows/r_build_min.yml
    with:
      revision: ${{ inputs.revision }}
      distribution: ${{ inputs.distribution }}
      architecture: ${{ inputs.architecture }}

  assemble:
    needs: [ build_min ]
    uses: ./.github/workflows/r_assemble.yml
    with:
      revision: ${{ inputs.revision }}
      distribution: ${{ inputs.distribution }}
      architecture: ${{ inputs.architecture }}

  test:
    needs: [ assemble ]
    uses: ./.github/workflows/r_test.yml
    with:
      revision: ${{ inputs.revision }}
      distribution: ${{ inputs.distribution }}
      architecture: ${{ inputs.architecture }}

  upload:
    if: ${{ inputs.upload }}
    needs: [ test ]
    uses: ./.github/workflows/r_upload.yml
    with:
      revision: ${{ inputs.revision }}
      distribution: ${{ inputs.distribution }}
      architecture: ${{ inputs.architecture }}
    secrets: inherit
