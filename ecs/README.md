### ECS mappings generator

This script generates the ECS mappings for the Wazuh indices.

#### Requirements

- ECS repository clone. The script is meant to be launched from the root level of that repository.
- Python 3.6 or higher
- jq

#### Folder structrue

There is a folder for each module. Inside each folder, there is a `fields` folder with the required 
files to generate the mappings. These are the inputs for the ECS generator.

#### Usage

**Copy the `generate.sh` script to the root level of the ECS repository.**

Use the `generate.sh` script to generate the mappings for a module. The script takes 3 arguments, 
plus 2 optional arguments to upload the mappings to the Wazuh indexer (using **composable** indexes).


```plaintext
Usage: ./generate.sh <ECS_VERSION> <INDEXER_SRC> <MODULE> [--upload <URL>]
  * ECS_VERSION: ECS version to generate mappings for
  * INDEXER_SRC: Path to the wazuh-indexer repository
  * MODULE: Module to generate mappings for
  * --upload <URL>: Upload generated index template to the OpenSearch cluster. Defaults to https://localhost:9200
Example: ./generate.sh v8.10.0 ~/wazuh-indexer vulnerability-detector --upload https://indexer:9200
``` 

For example, to generate the mappings for the `vulnerability-detector` module using the
ECS version `v8.10.0` and the Wazuh indexer in path `~/wazuh/wazuh-indexer`:
```bash
./generate.sh v8.10.0 ~/wazuh/wazuh-indexer vulnerability-detector
```

#### Output

A new `mappings` folder will be created inside the module folder, containing all the generated files.
The files are versioned using the ECS version, so different versions of the same module can be generated.
For our use case, the most important files are under `mappings/<ECS_VERSION>/generated/elasticsearch/legacy/`:

- `template.json`: Elasticsearch compatible index template for the module
- `opensearch-template.json`: OpenSearch compatible index template for the module

The original output is `template.json`, which is not compatible with OpenSearch by default. In order 
to make this template compatible with OpenSearch, the following changes are made:

- the `order` property is renamed to `priority`. 
- the `mappings` and `settings` properties are nested under the `template` property.

The script takes care of these changes automatically, generating the `opensearch-template.json` file as a result.

#### Adding new mappings

The easiest way to create mappings for a new module is to take a previous one as a base.
Copy a folder and rename it to the new module name. Then, edit the `fields` files to
match the new module fields.

The name of the folder will be the name of the module to be passed to the script. All 3 files
are required.

- `fields/subset.yml`: This file contains the subset of ECS fields to be used for the module.
- `fields/template-settings-legacy.json`: This file contains the legacy template settings for the module.
- `fields/template-settings.json`: This file contains the composable template settings for the module.

#### References

- [ECS repository](https://github.com/elastic/ecs)
- [ECS usage](https://github.com/elastic/ecs/blob/main/USAGE.md)
- [ECS field reference](https://www.elastic.co/guide/en/ecs/current/ecs-field-reference.html)
